<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
  body {
    margin: 0;
    background: #0a0a14;
    overflow: hidden;
    user-select: none;
    font-family: system-ui, -apple-system;
  }

  #viewer {
    position: relative;
    width: 100vw;
    height: 100vh;
    overflow: auto;
  }

  .page {
    margin: 12px auto;
    background: #fff;
  }

  canvas {
    display: block;
    margin: 0 auto;
    background: #fff;
  }

  /* MODE TOAST */
  #modeToast {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    color: #fff;
    padding: 6px 14px;
    border-radius: 12px;
    font-size: 13px;
    opacity: 0;
    transition: opacity .3s;
    z-index: 50;
  }
</style>
</head>

<body>

<div id="viewer"></div>
<div id="modeToast"></div>

<script>
/* ---------------- STATE ---------------- */
const params = new URLSearchParams(location.search);
const pdfUrl = params.get("file");

let pdfDoc = null;
let pageNum = 1;
let scale = 1.4;
const BASE_SCALE = 1.4;

let readingMode = "vertical"; // vertical | horizontal
let lastTap = 0;
let startX = 0;

const viewer = document.getElementById("viewer");
const toast = document.getElementById("modeToast");

pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

/* ---------------- LOAD PDF ---------------- */
pdfjsLib.getDocument(pdfUrl).promise.then(pdf => {
  pdfDoc = pdf;
  render();
});

/* ---------------- RENDER ---------------- */
function render() {
  viewer.innerHTML = "";
  if (readingMode === "vertical") renderVertical();
  else renderHorizontal();
}

function renderVertical() {
  for (let i = 1; i <= pdfDoc.numPages; i++) {
    pdfDoc.getPage(i).then(page => {
      const vp = page.getViewport({ scale });
      const canvas = document.createElement("canvas");
      canvas.width = vp.width;
      canvas.height = vp.height;
      canvas.className = "page";
      viewer.appendChild(canvas);
      page.render({ canvasContext: canvas.getContext("2d"), viewport: vp });
    });
  }
}

function renderHorizontal() {
  pdfDoc.getPage(pageNum).then(page => {
    const vp = page.getViewport({ scale });
    const canvas = document.createElement("canvas");
    canvas.width = vp.width;
    canvas.height = vp.height;
    canvas.className = "page";
    viewer.appendChild(canvas);
    page.render({ canvasContext: canvas.getContext("2d"), viewport: vp });
  });
}

/* ---------------- MODE TOGGLE ---------------- */
function toggleMode() {
  readingMode = readingMode === "vertical" ? "horizontal" : "vertical";
  showToast(readingMode === "vertical" ? "Vertical Mode" : "Horizontal Mode");
  render();
}

function showToast(text) {
  toast.textContent = text;
  toast.style.opacity = 1;
  setTimeout(() => toast.style.opacity = 0, 1000);
}

/* ---------------- GESTURES ---------------- */

// DOUBLE TAP → RESET ZOOM
viewer.addEventListener("touchend", e => {
  const now = Date.now();
  if (now - lastTap < 300) {
    scale = BASE_SCALE;
    document.body.style.zoom = "1";
    render();
  }
  lastTap = now;
});

// TWO-FINGER SWIPE → TOGGLE MODE
let twoFingerStartY = 0;
viewer.addEventListener("touchstart", e => {
  if (e.touches.length === 2) {
    twoFingerStartY =
      (e.touches[0].clientY + e.touches[1].clientY) / 2;
  }
});

// END → CHECK MODE SWITCH
viewer.addEventListener("touchend", e => {
  if (e.changedTouches.length === 1 && twoFingerStartY !== 0) {
    const endY = e.changedTouches[0].clientY;
    if (Math.abs(endY - twoFingerStartY) > 80) toggleMode();
    twoFingerStartY = 0;
  }
});

// HORIZONTAL PAGE CHANGE (ONLY IN HORIZONTAL MODE)
viewer.addEventListener("touchstart", e => {
  if (readingMode !== "horizontal") return;
  startX = e.touches[0].clientX;
});

viewer.addEventListener("touchend", e => {
  if (readingMode !== "horizontal") return;
  const diff = startX - e.changedTouches[0].clientX;

  if (Math.abs(diff) > 80) {
    if (diff > 0 && pageNum < pdfDoc.numPages) {
      pageNum++;
      render();
    }
    if (diff < 0 && pageNum > 1) {
      pageNum--;
      render();
    }
  }
});
</script>

</body>
</html>
