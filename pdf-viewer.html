<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
body {
  margin: 0;
  background: #0a0a14;
  overflow: hidden;
  user-select: none;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
  height: 100vh;
  width: 100vw;
  -webkit-tap-highlight-color: transparent;
}

#viewer {
  width: 100%;
  height: 100%;
  overflow: auto;
  touch-action: pan-y pinch-zoom;
  -webkit-overflow-scrolling: touch;
}

.page-container {
  position: relative;
  margin: auto;
  padding: 10px 0;
}

canvas {
  display: block;
  max-width: 100%;
  background: white;
  border-radius: 4px;
}

/* Highlight */
.highlight {
  position: absolute;
  background: rgba(250,204,21,0.4);
  border-radius: 4px;
}

.highlight.selected {
  outline: 2px solid #7c4dff;
}

/* UI */
#pageIndicator, #modeIndicator {
  position: fixed;
  top: 15px;
  padding: 6px 14px;
  background: rgba(17,24,39,.9);
  color: white;
  border-radius: 20px;
  font-size: 13px;
  z-index: 10;
}

#pageIndicator { right: 15px; }
#modeIndicator { left: 15px; }

/* Color Picker */
#colorPicker {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  display: none;
  gap: 12px;
  background: rgba(17,24,39,.9);
  padding: 12px 16px;
  border-radius: 40px;
  z-index: 20;
}

.color {
  width: 34px;
  height: 34px;
  border-radius: 50%;
  border: 3px solid transparent;
}

.color.active { border-color: white; }

/* Note Sheet */
#noteSheet {
  position: fixed;
  bottom: -100%;
  left: 0;
  width: 100%;
  background: #111827;
  border-radius: 20px 20px 0 0;
  padding: 20px;
  transition: bottom .3s;
  z-index: 100;
}

textarea {
  width: 100%;
  height: 120px;
  background: #1f2937;
  color: white;
  border-radius: 12px;
  padding: 12px;
  border: 2px solid #374151;
}

#saveNote {
  width: 100%;
  margin-top: 12px;
  padding: 14px;
  background: #7c4dff;
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
}

/* Toast */
.toast {
  position: fixed;
  bottom: 90px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(17,24,39,.95);
  color: white;
  padding: 10px 20px;
  border-radius: 12px;
  opacity: 0;
  transition: .3s;
  z-index: 1000;
}

.toast.show { opacity: 1; }

/* Instructions */
#instructions {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(17,24,39,.9);
  color: #9ca3af;
  padding: 10px 18px;
  border-radius: 12px;
  font-size: 12px;
  z-index: 10;
}
</style>
</head>

<body>

<div id="viewer"></div>

<div id="pageIndicator">Page: 1/1</div>
<div id="modeIndicator">Mode: View</div>

<div id="colorPicker">
  <div class="color active" style="background:#facc15" data-color="rgba(250,204,21,0.4)"></div>
  <div class="color" style="background:#4ade80" data-color="rgba(74,222,128,0.4)"></div>
  <div class="color" style="background:#60a5fa" data-color="rgba(96,165,250,0.4)"></div>
  <div class="color" style="background:#f472b6" data-color="rgba(244,114,182,0.4)"></div>
</div>

<div id="instructions">
Long press to highlight • Double tap to zoom/reset • Swipe left/right for pages
</div>

<div id="noteSheet">
  <textarea placeholder="Write note..."></textarea>
  <button id="saveNote">Save Note</button>
</div>

<div class="toast" id="toast"></div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

const viewer = document.getElementById("viewer");
const toast = document.getElementById("toast");
const picker = document.getElementById("colorPicker");
const sheet = document.getElementById("noteSheet");
const textarea = sheet.querySelector("textarea");

let pdfDoc, pageNum = 1, scale = 1, fitToWidth = true;
let canvas, container;
let annotationMode = false;
let activeHighlight = null;
let currentColor = "rgba(250,204,21,0.4)";
let lastTapTime = 0, lastTapX = 0, lastTapY = 0;
let startX = 0, startY = 0;

const params = new URLSearchParams(location.search);
const pdfUrl = params.get("file") || "demo.pdf";
const storeKey = "ann_" + pdfUrl;

function showToast(msg) {
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 2000);
}

function saveAnn(a) {
  const d = JSON.parse(localStorage.getItem(storeKey) || "[]");
  d.push(a);
  localStorage.setItem(storeKey, JSON.stringify(d));
}

function loadAnn() {
  const d = JSON.parse(localStorage.getItem(storeKey) || "[]");
  d.filter(x => x.page === pageNum).forEach(h => {
    const el = document.createElement("div");
    el.className = "highlight";
    Object.assign(el.style, h);
    container.appendChild(el);
  });
}

async function render() {
  viewer.innerHTML = "";
  const page = await pdfDoc.getPage(pageNum);
  const vp = page.getViewport({ scale: 1 });

  if (fitToWidth) scale = (window.innerWidth - 20) / vp.width;

  const viewport = page.getViewport({ scale });
  container = document.createElement("div");
  container.className = "page-container";
  canvas = document.createElement("canvas");

  canvas.width = viewport.width;
  canvas.height = viewport.height;
  container.appendChild(canvas);
  viewer.appendChild(container);

  await page.render({ canvasContext: canvas.getContext("2d"), viewport }).promise;
  loadAnn();

  document.getElementById("pageIndicator").textContent =
    `Page: ${pageNum}/${pdfDoc.numPages}`;
}

pdfjsLib.getDocument(pdfUrl).promise.then(pdf => {
  pdfDoc = pdf;
  render();
});

viewer.addEventListener("touchstart", e => {
  if (e.touches.length !== 1) return;
  const t = e.touches[0];
  startX = t.clientX;
  startY = t.clientY;

  const now = Date.now();
  const d = Math.hypot(t.clientX - lastTapX, t.clientY - lastTapY);

  if (now - lastTapTime < 300 && d < 30) {
    fitToWidth = scale > 1.05;
    scale = fitToWidth ? 1 : scale * 1.5;
    render();
    showToast(fitToWidth ? "Zoom reset" : "Zoom in");
    lastTapTime = 0;
    return;
  }

  lastTapTime = now;
  lastTapX = t.clientX;
  lastTapY = t.clientY;

  setTimeout(() => {
    annotationMode = true;
    picker.style.display = "flex";
    document.getElementById("modeIndicator").textContent = "Mode: Highlight";
  }, 650);
});

viewer.addEventListener("touchmove", e => {
  if (!annotationMode || e.touches.length !== 1) return;
  if (!activeHighlight) {
    activeHighlight = document.createElement("div");
    activeHighlight.className = "highlight";
    activeHighlight.style.background = currentColor;
    activeHighlight.style.left = startX + "px";
    activeHighlight.style.top = startY + "px";
    container.appendChild(activeHighlight);
  }
});

viewer.addEventListener("touchend", e => {
  if (activeHighlight) {
    saveAnn({
      page: pageNum,
      left: activeHighlight.style.left,
      top: activeHighlight.style.top,
      width: "60px",
      height: "25px",
      background: currentColor
    });
    activeHighlight = null;
    annotationMode = false;
    picker.style.display = "none";
    document.getElementById("modeIndicator").textContent = "Mode: View";
  }

  const dx = e.changedTouches[0].clientX - startX;
  const dy = e.changedTouches[0].clientY - startY;

  if (Math.abs(dx) > 80 && Math.abs(dx) > Math.abs(dy)) {
    if (dx < 0 && pageNum < pdfDoc.numPages) pageNum++;
    if (dx > 0 && pageNum > 1) pageNum--;
    render();
  }
});

picker.querySelectorAll(".color").forEach(c => {
  c.onclick = () => {
    currentColor = c.dataset.color;
    picker.querySelectorAll(".color").forEach(x => x.classList.remove("active"));
    c.classList.add("active");
  };
});
</script>

</body>
</html>
