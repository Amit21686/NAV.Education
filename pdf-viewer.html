<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />

<meta name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
  body {
    margin: 0;
    background: #0a0a14;
    overflow: hidden;
    touch-action: pan-x pan-y pinch-zoom;
    user-select: none;
  }

  #viewer {
    width: 100vw;
    height: 100vh;
    overflow: auto;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  canvas {
    background: white;
    max-width: 100%;
    height: auto;
  }

  .highlight {
    position: absolute;
    background: rgba(255, 255, 0, 0.35);
    border-radius: 4px;
  }

  .note {
    position: absolute;
    background: #111827;
    color: #fff;
    padding: 6px 8px;
    border-radius: 6px;
    font-size: 12px;
    max-width: 160px;
  }
</style>
</head>

<body>

<div id="viewer"></div>

<script>
  const params = new URLSearchParams(location.search);
  const pdfUrl = params.get("file");
  const storageKey = "pdf_annotations_" + pdfUrl;

  let pdfDoc = null;
  let pageNum = 1;
  let scale = 1.4;
  let startX = 0;
  let pressTimer = null;
  let isLongPress = false;

  const viewer = document.getElementById("viewer");

  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

  /* ---------- LOAD PDF (OFFLINE CACHE) ---------- */
  pdfjsLib.getDocument({
    url: pdfUrl,
    disableStream: false,
    disableAutoFetch: false
  }).promise.then(pdf => {
    pdfDoc = pdf;
    renderPage(pageNum);
    loadAnnotations();
  });

  function renderPage(num) {
    pdfDoc.getPage(num).then(page => {
      viewer.innerHTML = "";

      const viewport = page.getViewport({ scale });
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      canvas.width = viewport.width;
      canvas.height = viewport.height;

      viewer.appendChild(canvas);

      page.render({
        canvasContext: ctx,
        viewport
      });
    });
  }

  /* ---------- SWIPE PAGE ---------- */
  viewer.addEventListener("touchstart", e => {
    startX = e.touches[0].clientX;
    isLongPress = false;

    pressTimer = setTimeout(() => {
      isLongPress = true;
    }, 600);
  });

  viewer.addEventListener("touchend", e => {
    clearTimeout(pressTimer);

    const endX = e.changedTouches[0].clientX;
    const diff = startX - endX;

    if (!isLongPress && Math.abs(diff) > 80) {
      if (diff > 0 && pageNum < pdfDoc.numPages) {
        pageNum++;
        renderPage(pageNum);
        loadAnnotations();
      }
      if (diff < 0 && pageNum > 1) {
        pageNum--;
        renderPage(pageNum);
        loadAnnotations();
      }
    }
  });

  /* ---------- LONG PRESS = ADD NOTE ---------- */
  viewer.addEventListener("touchstart", e => {
    pressTimer = setTimeout(() => {
      const text = prompt("Add note:");
      if (!text) return;

      const rect = {
        x: e.touches[0].clientX,
        y: e.touches[0].clientY,
        text,
        page: pageNum
      };

      saveAnnotation(rect);
      showNote(rect);
    }, 700);
  });

  function saveAnnotation(note) {
    const data = JSON.parse(localStorage.getItem(storageKey) || "[]");
    data.push(note);
    localStorage.setItem(storageKey, JSON.stringify(data));
  }

  function loadAnnotations() {
    const data = JSON.parse(localStorage.getItem(storageKey) || "[]");
    data.filter(n => n.page === pageNum).forEach(showNote);
  }

  function showNote(note) {
    const div = document.createElement("div");
    div.className = "note";
    div.style.left = note.x + "px";
    div.style.top = note.y + "px";
    div.innerText = note.text;
    viewer.appendChild(div);
  }
</script>

</body>
</html>
